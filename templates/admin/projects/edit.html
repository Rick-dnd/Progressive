{% extends 'admin/base.html' %}

{% block title %}Edit Project - Admin - Elegant Progressive Ladies Club Munich e.V.{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css" rel="stylesheet">
<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .color-preview {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 5px;
        margin-left: 10px;
        vertical-align: middle;
        border: 1px solid #ddd;
    }
    
    .icon-picker {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 10px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    
    .icon-item {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 5px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }
    
    .icon-item:hover {
        background-color: #e9ecef;
    }
    
    .icon-item.selected {
        background-color: #9c27b0;
        color: white;
    }
    
    .icon-item i {
        font-size: 20px;
        display: block;
        margin-bottom: 5px;
    }
    
    .icon-item span {
        font-size: 10px;
        display: block;
        word-break: break-all;
    }
    
    .icon-search {
        margin-bottom: 10px;
    }
    
    .gradient-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    
    .gradient-preset {
        width: 50px;
        height: 30px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .gradient-preset:hover {
        transform: scale(1.1);
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    
    .gradient-preset.selected {
        border: 2px solid #333;
        box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    #icon-preview {
        font-size: 2rem;
        margin-top: 10px;
        color: #9c27b0;
    }

    .auto-icon-info {
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 8px;
    }
    
    /* Color Picker anpassungen */
    .sp-replacer {
        border-radius: 4px;
        border: 1px solid #ced4da;
        padding: 4px;
        background: white;
    }
    
    .sp-preview {
        border-radius: 3px;
        border: 1px solid #ddd;
    }
    
    .sp-container {
        border-radius: 5px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('project_index') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="admin-title mb-0">
                    <i class="fas fa-edit"></i> Edit Project
                </h1>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="admin-card">
                <div class="admin-card-header">
                    <h2>{{ project.title }}</h2>
                </div>
                <div class="admin-card-body">
                    <form action="{{ url_for('project_edit', id=project.id) }}" method="post">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" value="{{ project.title }}" required>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ project.start_date.strftime('%Y-%m-%d') }}" required>
                                </div>
                            </div>
                            
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="description" class="form-label">Short Description <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="description" name="description" rows="2" required>{{ project.description }}</textarea>
                                    <small class="text-muted">Maximum 255 characters for the overview on the homepage.</small>
                                </div>
                            </div>
                            
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="details" class="form-label">Detailed Description</label>
                                    <textarea class="form-control" id="details" name="details" rows="10">{{ project.details }}</textarea>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="" disabled>Please select...</option>
                                        <option value="bildung" {% if project.category == 'bildung' %}selected{% endif %}>Education</option>
                                        <option value="hilfe" {% if project.category == 'hilfe' %}selected{% endif %}>Help</option>
                                        <option value="spenden" {% if project.category == 'spenden' %}selected{% endif %}>Money (Donations)</option>
                                        <option value="feiern" {% if project.category == 'feiern' %}selected{% endif %}>Celebrations (Parties)</option>
                                        <option value="natur" {% if project.category == 'natur' %}selected{% endif %}>Nature</option>
                                        <option value="gemeinschaft" {% if project.category == 'gemeinschaft' %}selected{% endif %}>Community</option>
                                        <option value="kultur" {% if project.category == 'kultur' %}selected{% endif %}>Culture & Art</option>
                                        <option value="sport" {% if project.category == 'sport' %}selected{% endif %}>Sports</option>
                                        <option value="technologie" {% if project.category == 'technologie' %}selected{% endif %}>Technology</option>
                                        <option value="gesundheit" {% if project.category == 'gesundheit' %}selected{% endif %}>Health</option>
                                        <option value="familie" {% if project.category == 'familie' %}selected{% endif %}>Family</option>
                                        <option value="andere" {% if project.category == 'andere' or not project.category %}selected{% endif %}>Other</option>
                                    </select>
                                    <div id="icon-preview" class="mt-3" style="font-size: 2.5rem; color: #9c27b0; text-align: center;">
                                        <i class="fas {% if project.icon %}{{ project.icon }}{% else %}fa-project-diagram{% endif %}"></i>
                                    </div>
                                    <!-- Verstecktes Feld für das tatsächliche Icon -->
                                    <input type="hidden" id="icon" name="icon" value="{% if project.icon %}{{ project.icon }}{% else %}fa-project-diagram{% endif %}">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="color" class="form-label">Color/Gradient <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="color" name="color" value="{{ project.color }}" required>
                                    <small class="text-muted d-block mb-2">Choose a gradient from the templates below or use the color picker for a custom color.</small>
                                    <div class="mt-2">
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #9c38d1, #e74694); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-purple-600 to-pink-500'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #9c38d1, #e74694)'; highlightButton(this);"></button>
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #10b981, #2dd4bf); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-green-500 to-teal-400'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #10b981, #2dd4bf)'; highlightButton(this);"></button>
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #3b82f6, #6366f1); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-blue-500 to-indigo-500'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #3b82f6, #6366f1)'; highlightButton(this);"></button>
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #ef4444, #eab308); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-red-500 to-yellow-500'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #ef4444, #eab308)'; highlightButton(this);"></button>
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #a855f7, #ec4899); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-purple-500 to-pink-500'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #a855f7, #ec4899)'; highlightButton(this);"></button>
                                        <button type="button" class="btn p-0" style="background: linear-gradient(to right, #8b5cf6, #3b82f6); width: 50px; height: 30px; margin-right: 10px; border: 2px solid transparent; border-radius: 5px;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onclick="document.getElementById('color').value = 'bg-gradient-to-r from-violet-500 to-blue-500'; document.getElementById('colorPreview').style.background = 'linear-gradient(to right, #8b5cf6, #3b82f6)'; highlightButton(this);"></button>
                                    </div>
                                    <div class="mt-3 d-flex align-items-center">
                                        <label for="colorPicker" class="me-2">Custom Color:</label>
                                        <input type="text" id="colorPicker" class="d-inline-block">
                                        <div id="colorPreview" class="color-preview ms-3"></div>
                                        <small class="text-muted ms-2">Preview</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="position" class="form-label">Order</label>
                                    <input type="number" class="form-control" id="position" name="position" value="{{ project.position or 999 }}" min="1" max="9999">
                                    <small class="text-muted">Projects with higher values are displayed first. 3 is displayed before 2, 2 before 1, etc.</small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="is_current" name="is_current" {% if project.is_current %}checked{% endif %}>
                                    <label class="form-check-label" for="is_current">
                                        Current Project
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the project 
                <span title="{{ project.title }}">"{{ project.title|truncate(40, true, '...') }}"</span>? 
                This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('project_delete', id=project.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
<script src="{{ url_for('static', filename='js/admin-forms.js') }}"></script>
<script>
    // Debug-Funktion
    function logDebug(message) {
        console.log('[DEBUG] ' + message);
    }

    // Diese Funktion sorgt dafür, dass das Icon sofort aktualisiert wird
    function updateIconForCategory(category) {
        console.log('Update Icon for category: ' + category);
        
        // Mapping von Kategorien zu Icons
        var iconMap = {
            'bildung': 'fa-graduation-cap',
            'hilfe': 'fa-hands-helping',
            'spenden': 'fa-donate',
            'feiern': 'fa-glass-cheers',
            'natur': 'fa-leaf',
            'gemeinschaft': 'fa-users',
            'kultur': 'fa-theater-masks',
            'sport': 'fa-running',
            'technologie': 'fa-microchip',
            'gesundheit': 'fa-heartbeat',
            'familie': 'fa-home',
            'andere': 'fa-project-diagram'
        };
        
        // Icon basierend auf Kategorie setzen
        var iconClass = 'fa-project-diagram'; // Standard-Icon
        
        if (category && iconMap[category]) {
            iconClass = iconMap[category];
            console.log('Icon found: ' + iconClass);
        }
        
        // Icon-Vorschau aktualisieren
        var iconPreview = document.getElementById('icon-preview');
        if (iconPreview) {
            iconPreview.innerHTML = '<i class="fas ' + iconClass + '"></i>';
            console.log('Preview updated with: ' + iconClass);
        }
        
        // Wert im versteckten Feld aktualisieren
        var iconField = document.getElementById('icon');
        if (iconField) {
            iconField.value = iconClass;
            console.log('Hidden field updated with: ' + iconClass);
        }
    }

    function highlightButton(button) {
        // Alle Buttons zurücksetzen
        var buttons = document.querySelectorAll('.btn.p-0');
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].style.border = '2px solid transparent';
            buttons[i].style.boxShadow = 'none';
        }
        
        // Ausgewählten Button hervorheben
        button.style.border = '2px solid #333';
        button.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
    }
    
    // Farbvorschau aktualisieren
    function updateColorPreview(colorValue) {
        try {
            const colorPreview = document.getElementById('colorPreview');
            if (colorPreview) {
                if (colorValue.includes('bg-gradient-to-r')) {
                    // Für Tailwind-Gradienten
                    const tailwindClasses = colorValue.split(' ');
                    let fromColor = '#9c27b0'; // Standardwert
                    let toColor = '#e74694';   // Standardwert
                    
                    // Tailwind-Farben zu CSS-Farben
                    const tailwindToCSS = {
                        'from-purple-600': '#9c38d1',
                        'from-purple-500': '#a855f7',
                        'from-green-500': '#10b981',
                        'from-blue-500': '#3b82f6',
                        'from-red-500': '#ef4444',
                        'from-violet-500': '#8b5cf6',
                        'to-pink-500': '#e74694',
                        'to-teal-400': '#2dd4bf',
                        'to-indigo-500': '#6366f1',
                        'to-yellow-500': '#eab308',
                        'to-blue-500': '#3b82f6',
                        'to-pink-500': '#ec4899'
                    };
                    
                    tailwindClasses.forEach(cls => {
                        if (cls.startsWith('from-') && tailwindToCSS[cls]) {
                            fromColor = tailwindToCSS[cls];
                        } else if (cls.startsWith('to-') && tailwindToCSS[cls]) {
                            toColor = tailwindToCSS[cls];
                        }
                    });
                    
                    colorPreview.style.background = `linear-gradient(to right, ${fromColor}, ${toColor})`;
                } else if (colorValue.startsWith('#')) {
                    // Für Hex-Farben
                    colorPreview.style.background = colorValue;
                } else {
                    // Für andere Formate
                    colorPreview.style.background = '#9c27b0';
                }
            }
        } catch (error) {
            console.error('Error updating color preview:', error);
        }
    }

    // Alles im Document Ready umschließen
    $(document).ready(function() {
        console.log('Document ready!');
        
        // Summernote Editor initialisieren
        $('#details').summernote({
            height: 300,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });
        
        // WICHTIG: Den change-Event-Handler direkt binden
        $('#category').change(function() {
            console.log('Kategorie geändert zu: ' + this.value);
            updateIconForCategory(this.value);
        });
        
        // Initiale Kategorie setzen
        var initialCategory = $('#category').val();
        console.log('Initiale Kategorie: ' + initialCategory);
        if (initialCategory) {
            updateIconForCategory(initialCategory);
        }
        
        // Auch den onchange-Handler des select-Elements entfernen und neu setzen
        document.getElementById('category').removeAttribute('onchange');
        
        // Color Picker konfigurieren
        $('#colorPicker').spectrum({
            preferredFormat: "hex",
            showInput: true,
            showPalette: true,
            showSelectionPalette: true,
            palette: [
                ["#9c27b0", "#e91e63", "#f44336", "#ff9800"],
                ["#4caf50", "#8bc34a", "#cddc39", "#2196f3"],
                ["#3f51b5", "#673ab7", "#00bcd4", "#009688"]
            ],
            change: function(color) {
                const hexColor = color.toHexString();
                $('#color').val(hexColor);
                updateColorPreview(hexColor);
            }
        });
        
        // Initialen Farbwert setzen
        const initialColor = $('#color').val();
        if (initialColor) {
            if (initialColor.startsWith('#')) {
                $('#colorPicker').spectrum("set", initialColor);
            }
            updateColorPreview(initialColor);
        }
        
        // Event-Handler für manuelle Änderungen am Farbfeld
        $('#color').on('input', function() {
            const colorValue = $(this).val();
            updateColorPreview(colorValue);
        });
    });
</script>
{% endblock %} 